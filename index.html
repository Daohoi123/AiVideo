<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Video Generation</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758271750/logo_dia1pb.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758006412/nen_ephcrp.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        
        .loading-gif {
            width: 150px;
            height: 150px;
            mix-blend-mode: screen;
        }
        @media (min-width: 1024px) {
            .loading-gif {
                width: 200px;
                height: 200px;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .drop-zone-active {
            outline: 2px dashed #3b82f6; /* blue-500 */
            outline-offset: -4px;
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        /* New UI Styles */
        .nav-item {
            padding: 8px;
            border-radius: 12px;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            width: 70px; /* Set fixed width */
            height: 70px; /* Set fixed height */
        }
        @media (min-width: 1024px) {
            .nav-item {
                width: 80px;
                height: 80px;
            }
        }
        .nav-item.active {
            background-color: #2D3E50;
        }
        .nav-item.active img {
            transform: scale(1.15);
        }
        .nav-item img {
            transition: transform 0.2s ease-in-out;
        }
        .nav-text {
            color: #94a3b8; /* slate-400 */
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .nav-item.active .nav-text {
            color: white;
            font-weight: 600;
        }
        .control-section {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .control-select, .control-input {
            background-color: #F0F4F8;
            color: #1C2A3A;
            border: 1px solid #CBD5E1;
            border-radius: 8px;
            padding: 10px;
            width: 100%;
            font-size: 1rem;
        }
        .control-select:focus, .control-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3B82F6;
            border-color: #3B82F6;
        }
        
        /* Adapted styles for video app controls */
         .radio-label {
            background-color: #F0F4F8;
            color: #1C2A3A;
            border: 1px solid #CBD5E1;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        input[type="radio"]:checked + .radio-label {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
            font-weight: 600;
        }
        .custom-file-button {
            background-color: #475569; /* slate-600 */
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color: 0.2s;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .custom-file-button:hover {
            background-color: #334155; /* slate-700 */
        }
        
        /* Custom audio player */
        audio::-webkit-media-controls-panel {
            background-color: #f0f4f8;
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-mute-button {
            color: #1C2A3A;
        }
        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-volume-slider {
             background-color: #cbd5e1;
        }

    </style>
</head>
<body class="text-white">

    <div class="w-full max-w-7xl mx-auto flex flex-col lg:flex-row gap-4 p-4 min-h-screen lg:h-screen lg:py-4">
        
        <!-- Navigation Bar -->
        <nav class="flex flex-row lg:flex-col items-center justify-center lg:justify-start gap-4 bg-[#1C2A3A] p-2 lg:p-4 rounded-2xl shadow-lg w-full lg:w-auto">
            <button id="btn-text-to-video" class="nav-item active flex flex-col items-center justify-center text-center gap-y-1" title="Text to Video">
                <img src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758269262/T2Video_kbe59d.png" alt="Text 2V" class="w-8 h-8 lg:w-9 lg:h-9 object-contain">
                <span class="nav-text text-xs">Text 2V</span>
            </button>
            <button id="btn-image-to-video" class="nav-item flex flex-col items-center justify-center text-center gap-y-1" title="Image to Video">
                <img src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758269262/I2video_k2zd8k.png" alt="Image 2V" class="w-8 h-8 lg:w-9 lg:h-9 object-contain">
                <span class="nav-text text-xs">Image 2V</span>
            </button>
            <button id="btn-effect" class="nav-item flex flex-col items-center justify-center text-center gap-y-1" title="Hiệu ứng">
                <img src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758269262/effect_gwkcti.png" alt="Effect" class="w-8 h-8 lg:w-9 lg:h-9 object-contain">
                <span class="nav-text text-xs">Effect</span>
            </button>
             <button id="btn-lip-synch" class="nav-item flex flex-col items-center justify-center text-center gap-y-1" title="Lip Synch">
                <img src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758269262/lip_synch_isiaxq.png" alt="Lip Synch" class="w-8 h-8 lg:w-9 lg:h-9 object-contain">
                <span class="nav-text text-xs">Lip Synch</span>
            </button>
        </nav>

        <!-- Controls Panel -->
        <div class="w-full lg:w-1/3 lg:max-w-xs flex flex-col gap-4">
            <div class="control-section text-gray-800">
                <div id="controls-container" class="flex-grow overflow-y-auto pr-2">
                    <!-- Text to Video Controls -->
                    <div id="text-to-video-controls" class="flex flex-col space-y-4">
                        <div>
                            <label for="video-aspect-ratio" class="block text-sm font-medium mb-2">Khung hình</label>
                            <select id="video-aspect-ratio" class="control-select">
                                <option value="1">1:1</option>
                                <option value="2">9:16</option>
                                <option value="3">16:9</option>
                            </select>
                        </div>
                        <div>
                            <label for="video-duration" class="block text-sm font-medium mb-2">Thời gian (giây)</label>
                            <input type="number" id="video-duration" value="6" min="1" max="20" class="control-input">
                        </div>
                    </div>
                    
                    <!-- Image to Video Controls -->
                    <div id="image-to-video-controls" class="hidden flex-col space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Số ảnh đầu vào</label>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="radio" name="image-video-mode" id="mode-start-image" value="start" class="hidden" checked>
                                <label for="mode-start-image" class="radio-label">Start image</label>
                                
                                <input type="radio" name="image-video-mode" id="mode-start-end-image" value="start-end" class="hidden">
                                <label for="mode-start-end-image" class="radio-label">Start & End</label>
                            </div>
                        </div>
                        <div id="end-image-upload-container-i2v" class="hidden">
                            <label class="block text-sm font-medium mb-2">End Image</label>
                            <div class="flex items-center space-x-2">
                                <label for="end-image-input-i2v" id="end-image-label-i2v" class="custom-file-button">Chọn ảnh cuối</label>
                                <input type="file" id="end-image-input-i2v" accept="image/*" class="hidden">
                                <div id="end-image-preview-container-i2v" class="relative hidden">
                                    <img id="end-image-preview-i2v" class="h-12 w-12 object-cover rounded-md">
                                    <button id="remove-end-image-btn-i2v" class="absolute -top-1.5 -right-1.5 bg-red-600 rounded-full h-5 w-5 flex items-center justify-center text-white text-xs font-bold">&times;</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="resolution-itv" class="block text-sm font-medium mb-2">Độ phân giải</label>
                            <input type="number" id="resolution-itv" value="832" class="control-input">
                        </div>
                        <div>
                            <label for="duration-itv" class="block text-sm font-medium mb-2">Thời gian (giây)</label>
                            <input type="number" id="duration-itv" value="6" min="1" class="control-input">
                        </div>
                    </div>

                    <!-- Effect Controls -->
                    <div id="effect-controls" class="hidden flex-col space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">End Image (Tùy chọn)</label>
                            <div class="flex items-center space-x-2">
                                <label for="end-image-input-effect" id="end-image-label-effect" class="custom-file-button">Chọn ảnh cuối</label>
                                <input type="file" id="end-image-input-effect" accept="image/*" class="hidden">
                                <div id="end-image-preview-container-effect" class="relative hidden">
                                    <img id="end-image-preview-effect" class="h-12 w-12 object-cover rounded-md">
                                    <button id="remove-end-image-btn-effect" class="absolute -top-1.5 -right-1.5 bg-red-600 rounded-full h-5 w-5 flex items-center justify-center text-white text-xs font-bold">&times;</button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="effect-select" class="block text-sm font-medium mb-2">Chọn hiệu ứng</label>
                            <select id="effect-select" class="control-select">
                                <option value="1">Quay 360 độ</option>
                                <option value="2">Biến hình</option>
                                <option value="3">Hiệu ứng ma thuật</option>
                                <option value="4">Biến thành cô dâu</option>
                                <option value="5">Khoe cơ bắp</option>
                                <option value="6">Đổ nước vào người</option>
                                <option value="7">Kiss</option>
                                <option value="8">Tan biến</option>
                                <option value="9">Catwalk</option>
                            </select>
                        </div>
                        <div>
                            <label for="duration-effect" class="block text-sm font-medium mb-2">Thời gian (giây)</label>
                            <input type="number" id="duration-effect" value="5" min="1" class="control-input">
                        </div>
                    </div>
                    
                    <!-- Lip Synch Controls -->
                    <div id="lip-synch-controls" class="hidden flex-col space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Audio</label>
                             <div class="flex items-center space-x-2">
                                <label for="audio-input" class="custom-file-button">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.293 3.293a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 6.414V16a1 1 0 11-2 0V6.414L4.707 10.707a1 1 0 01-1.414-1.414l6-6z" clip-rule="evenodd" /></svg>
                                    <span>Tải lên Audio</span>
                                </label>
                                <input type="file" id="audio-input" accept="audio/*" class="hidden">
                            </div>
                             <div id="audio-preview-container" class="relative hidden flex-col items-start gap-2 bg-slate-200 p-2 rounded-lg mt-2">
                                <div class="w-full flex items-center justify-between">
                                    <span id="audio-filename" class="text-sm text-slate-700 truncate max-w-[150px]"></span>
                                    <button id="remove-audio-btn" class="bg-red-600 rounded-full h-5 w-5 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">&times;</button>
                                </div>
                                <audio id="audio-player" controls class="w-full h-8 hidden"></audio>
                            </div>
                        </div>
                         <div>
                            <label for="duration-lipsynch" class="block text-sm font-medium mb-2">Thời gian (giây)</label>
                            <input type="number" id="duration-lipsynch" value="10" min="1" class="control-input">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Panel: Display & Prompt -->
        <div class="flex-1 flex flex-col bg-transparent gap-4 min-h-0">
            <!-- Display Area -->
            <div id="display-area" class="flex-1 flex items-center justify-center rounded-2xl p-2 relative overflow-hidden min-h-[50vh] lg:min-h-0" style="background-image: url('https://res.cloudinary.com/dzfuqyqoq/image/upload/v1758008305/nen_gif_wcbayk.gif'); background-size: cover; background-position: center;">
                <img id="fallback-image" src="https://placehold.co/1024x1024/ffffff/ffffff" alt="Vùng hiển thị kết quả" class="max-w-full max-h-full object-contain opacity-0">
                <video id="result-video" class="hidden max-w-full max-h-full" controls autoplay loop muted playsinline></video>

                <!-- Status Overlay -->
                <div id="status-overlay" class="absolute inset-0 hidden z-30">
                    <img id="loading-bg-image" src="" class="absolute inset-0 w-full h-full object-cover">
                    <div id="loading-overlay-color" class="absolute inset-0 bg-black bg-opacity-50"></div>
                    <div class="absolute inset-0 flex flex-col items-center justify-center text-center px-4">
                        <img src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1755349021/loading_ok_kdesfk.gif" alt="Đang xử lý..." class="loading-gif">
                        <p id="status-message" class="text-lg text-white font-bold mt-4"></p>
                        <p id="error-message" class="text-red-400 mt-2 font-semibold"></p>
                    </div>
                    <!-- Cancel Button -->
                    <div class="absolute bottom-4 right-4 group">
                        <button id="cancel-btn" class="bg-red-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg transform transition-all hover:scale-110 focus:outline-none opacity-0 group-hover:opacity-100" title="Hủy tác vụ">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Prompt Input Area -->
            <div id="prompt-container" class="bg-white rounded-2xl p-2 flex items-center space-x-3 shadow-lg">
                <label for="file-input" class="cursor-pointer p-2 rounded-full bg-[#E5F5FF] hover:bg-blue-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6" /></svg>
                </label>
                <input type="file" id="file-input" accept="image/*" class="hidden">
                
                <div id="image-preview-container" class="relative hidden h-12 w-12">
                    <img id="image-preview" class="h-full w-full object-cover rounded-md">
                    <button id="remove-image-btn" class="absolute -top-1.5 -right-1.5 bg-red-600 rounded-full h-5 w-5 flex items-center justify-center text-white text-xs font-bold">&times;</button>
                </div>

                <input type="text" id="prompt-input" class="flex-1 bg-transparent text-gray-800 placeholder-gray-500 focus:outline-none" placeholder="Nhập prompt của bạn...">
                
                <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 rounded-lg p-3 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="white" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM ELEMENTS ---
        const fallbackImage = document.getElementById('fallback-image');
        const resultVideo = document.getElementById('result-video');
        const statusOverlay = document.getElementById('status-overlay');
        const statusMessage = document.getElementById('status-message');
        const errorMessage = document.getElementById('error-message');
        const loadingBgImage = document.getElementById('loading-bg-image');
        const loadingOverlayColor = document.getElementById('loading-overlay-color');
        const cancelBtn = document.getElementById('cancel-btn');
        const promptContainer = document.getElementById('prompt-container');
        const fileInput = document.getElementById('file-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const promptInput = document.getElementById('prompt-input');
        const sendBtn = document.getElementById('send-btn');
        
        // Tabs and Controls
        const btnTextToVideo = document.getElementById('btn-text-to-video');
        const btnImageToVideo = document.getElementById('btn-image-to-video');
        const btnEffect = document.getElementById('btn-effect');
        const btnLipSynch = document.getElementById('btn-lip-synch');
        const textToVideoControls = document.getElementById('text-to-video-controls');
        const imageToVideoControls = document.getElementById('image-to-video-controls');
        const effectControls = document.getElementById('effect-controls');
        const lipSynchControls = document.getElementById('lip-synch-controls');
        const navButtons = [btnTextToVideo, btnImageToVideo, btnEffect, btnLipSynch];
        const controlPanels = [textToVideoControls, imageToVideoControls, effectControls, lipSynchControls];

        // Text to Video
        const videoAspectRatioSelect = document.getElementById('video-aspect-ratio');
        const videoDurationInput = document.getElementById('video-duration');

        // Image to Video
        const imageVideoModeRadios = document.querySelectorAll('input[name="image-video-mode"]');
        const endImageUploadContainerI2V = document.getElementById('end-image-upload-container-i2v');
        const endImageInputI2V = document.getElementById('end-image-input-i2v');
        const endImageLabelI2V = document.getElementById('end-image-label-i2v');
        const endImagePreviewContainerI2V = document.getElementById('end-image-preview-container-i2v');
        const endImagePreviewI2V = document.getElementById('end-image-preview-i2v');
        const removeEndImageBtnI2V = document.getElementById('remove-end-image-btn-i2v');
        const resolutionITV = document.getElementById('resolution-itv');
        const durationITV = document.getElementById('duration-itv');

        // Effect
        const endImageInputEffect = document.getElementById('end-image-input-effect');
        const endImageLabelEffect = document.getElementById('end-image-label-effect');
        const endImagePreviewContainerEffect = document.getElementById('end-image-preview-container-effect');
        const endImagePreviewEffect = document.getElementById('end-image-preview-effect');
        const removeEndImageBtnEffect = document.getElementById('remove-end-image-btn-effect');
        const effectSelect = document.getElementById('effect-select');
        const durationEffect = document.getElementById('duration-effect');

        // Lip Synch
        const audioInput = document.getElementById('audio-input');
        const audioPreviewContainer = document.getElementById('audio-preview-container');
        const audioFilename = document.getElementById('audio-filename');
        const removeAudioBtn = document.getElementById('remove-audio-btn');
        const audioPlayer = document.getElementById('audio-player');
        const durationLipsynch = document.getElementById('duration-lipsynch');

        // --- STATE MANAGEMENT ---
        let uploadedImageFile = null;
        let endImageFileI2V = null;
        let endImageFileEffect = null;
        let uploadedAudioFile = null;
        let activeVideoMode = 'text-to-video';
        
        // New state for polling logic
        let currentTaskId = null;
        let statusInterval = null;
        const API_KEY = "d80bce5a3a1a467c8f9eb2f105b39aea";
        
        const CLOUDINARY_CLOUD_NAME = "dzfuqyqoq";
        const CLOUDINARY_UPLOAD_PRESET = "daoquochoi";

        // --- UI LOGIC ---
        function switchVideoMode(mode) {
            activeVideoMode = mode;
            
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.id === `btn-${mode}`);
            });

            controlPanels.forEach(panel => {
                const isVisible = panel.id.startsWith(mode);
                panel.style.display = isVisible ? 'flex' : 'none';
            });
        }
        
        btnTextToVideo.addEventListener('click', () => switchVideoMode('text-to-video'));
        btnImageToVideo.addEventListener('click', () => switchVideoMode('image-to-video'));
        btnEffect.addEventListener('click', () => switchVideoMode('effect'));
        btnLipSynch.addEventListener('click', () => switchVideoMode('lip-synch'));

        imageVideoModeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const showEndImage = e.target.value === 'start-end';
                endImageUploadContainerI2V.style.display = showEndImage ? 'block' : 'none';
            });
        });

        // End Image Upload Logic for I2V
        endImageInputI2V.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                endImageFileI2V = file;
                endImagePreviewI2V.src = URL.createObjectURL(file);
                endImagePreviewContainerI2V.classList.remove('hidden');
                endImageLabelI2V.classList.add('hidden');
            }
        });
        removeEndImageBtnI2V.addEventListener('click', () => {
            if (endImagePreviewI2V.src) URL.revokeObjectURL(endImagePreviewI2V.src);
            endImageFileI2V = null;
            endImageInputI2V.value = '';
            endImagePreviewContainerI2V.classList.add('hidden');
            endImageLabelI2V.classList.remove('hidden');
        });

        // End Image Upload Logic for Effect
        endImageInputEffect.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                endImageFileEffect = file;
                endImagePreviewEffect.src = URL.createObjectURL(file);
                endImagePreviewContainerEffect.classList.remove('hidden');
                endImageLabelEffect.classList.add('hidden');
            }
        });
        removeEndImageBtnEffect.addEventListener('click', () => {
            if(endImagePreviewEffect.src) URL.revokeObjectURL(endImagePreviewEffect.src);
            endImageFileEffect = null;
            endImageInputEffect.value = '';
            endImagePreviewContainerEffect.classList.add('hidden');
            endImageLabelEffect.classList.remove('hidden');
        });
        
        // Audio Upload Logic
        audioInput.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                uploadedAudioFile = file;
                audioFilename.textContent = file.name;
                const audioURL = URL.createObjectURL(file);
                audioPlayer.src = audioURL;
                audioPlayer.classList.remove('hidden');
                audioPreviewContainer.classList.remove('hidden');
            }
        });
        removeAudioBtn.addEventListener('click', () => {
            if (audioPlayer.src) {
                URL.revokeObjectURL(audioPlayer.src);
            }
            uploadedAudioFile = null;
            audioInput.value = '';
            audioFilename.textContent = '';
            audioPlayer.src = '';
            audioPlayer.classList.add('hidden');
            audioPreviewContainer.classList.add('hidden');
        });

        // --- MAIN IMAGE UPLOAD LOGIC (in chat) ---
        function handleFileSelect(file) {
            if (!file || !file.type.startsWith('image/')) return;
            uploadedImageFile = file;
            imagePreview.src = URL.createObjectURL(file);
            imagePreviewContainer.style.display = 'block';
        }
        
        fileInput.addEventListener('change', (e) => handleFileSelect(e.target.files[0]));
        promptContainer.addEventListener('dragover', (e) => { e.preventDefault(); e.currentTarget.style.backgroundColor = '#e0e0e0'; });
        promptContainer.addEventListener('dragleave', () => { e.currentTarget.style.backgroundColor = 'white'; });
        promptContainer.addEventListener('drop', (e) => { e.preventDefault(); e.currentTarget.style.backgroundColor = 'white'; handleFileSelect(e.dataTransfer.files[0]); });
        window.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (const item of items) {
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    handleFileSelect(item.getAsFile());
                    break; 
                }
            }
        });
        removeImageBtn.addEventListener('click', () => {
            if (imagePreview.src) URL.revokeObjectURL(imagePreview.src);
            uploadedImageFile = null;
            fileInput.value = '';
            imagePreviewContainer.style.display = 'none';
        });

        // --- CORE API LOGIC ---
        sendBtn.addEventListener('click', handleProcessingRequest);
        promptInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleProcessingRequest(); } });
        cancelBtn.addEventListener('click', cancelTask);

        function resetState() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
            }
            currentTaskId = null;
            errorMessage.textContent = '';
            setUiLoading(false);
        }
        
        function setUiLoading(isLoading, message = '') {
            if (isLoading) {
                statusMessage.textContent = message;
                errorMessage.textContent = '';
                
                const hasInputImage = (activeVideoMode !== 'text-to-video') && !!uploadedImageFile;

                if (hasInputImage) {
                    loadingBgImage.src = URL.createObjectURL(uploadedImageFile);
                    loadingBgImage.style.display = 'block';
                    loadingOverlayColor.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                } else {
                    loadingBgImage.style.display = 'none';
                    loadingOverlayColor.style.backgroundColor = 'rgb(30, 30, 30)';
                }
                statusOverlay.style.display = 'flex';
            } else {
                statusOverlay.style.display = 'none';
                if (loadingBgImage.src.startsWith('blob:')) {
                    URL.revokeObjectURL(loadingBgImage.src);
                    loadingBgImage.src = '';
                }
            }
        }

        async function uploadToCloudinary(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
            const resourceType = file.type.startsWith('image/') ? 'image' : 'video'; // Cloudinary uses 'video' for audio too
            const uploadUrl = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`;
            
            const response = await fetch(uploadUrl, { method: 'POST', body: formData });
            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                throw new Error(`Tải file lên Cloudinary thất bại: ${errorData?.error?.message || response.status}`);
            }
            return (await response.json()).secure_url;
        }
        
        async function handleProcessingRequest() {
            resetState();
            const promptText = promptInput.value.trim();
            
            setUiLoading(true, 'Đang chuẩn bị...');
            try {
                let webappId, nodeInfoList;
                
                if (activeVideoMode === 'text-to-video') {
                    if (!promptText) throw new Error('Vui lòng nhập prompt!');
                    webappId = "1933704660299468802";
                    nodeInfoList = [
                        { nodeId: "200", fieldName: "value", fieldValue: videoAspectRatioSelect.value },
                        { nodeId: "208", fieldName: "value", fieldValue: videoDurationInput.value },
                        { nodeId: "215", fieldName: "text", fieldValue: promptText }
                    ];
                } else if (activeVideoMode === 'image-to-video') {
                    const imageMode = document.querySelector('input[name="image-video-mode"]:checked').value;
                    if (!uploadedImageFile) throw new Error('Vui lòng tải lên "Start image"!');
                    setUiLoading(true, 'Đang tải ảnh lên...');
                    const startImageUrl = await uploadToCloudinary(uploadedImageFile);
                    webappId = "1957033462478639105";
                    nodeInfoList = [
                        { nodeId: "99", fieldName: "value", fieldValue: resolutionITV.value },
                        { nodeId: "95", fieldName: "value", fieldValue: durationITV.value },
                        { nodeId: "109", fieldName: "text", fieldValue: promptText },
                        { nodeId: "94", fieldName: "image", fieldValue: startImageUrl }
                    ];
                    if (imageMode === 'start-end') {
                        if (!endImageFileI2V) throw new Error('Vui lòng tải lên "End image"!');
                        const endImageUrl = await uploadToCloudinary(endImageFileI2V);
                        nodeInfoList.push(
                            { nodeId: "101", fieldName: "value", fieldValue: "2" },
                            { nodeId: "223", fieldName: "image", fieldValue: endImageUrl }
                        );
                    } else {
                        nodeInfoList.push({ nodeId: "101", fieldName: "value", fieldValue: "1" });
                    }
                } else if (activeVideoMode === 'effect') {
                    if (!uploadedImageFile) throw new Error('Vui lòng tải lên ảnh trong khung chat!');
                    setUiLoading(true, 'Đang tải ảnh lên...');
                    const startImageUrl = await uploadToCloudinary(uploadedImageFile);
                    webappId = "1960985154690985985";
                    nodeInfoList = [
                        { nodeId: "102", fieldName: "image", fieldValue: startImageUrl },
                        { nodeId: "38", fieldName: "value", fieldValue: durationEffect.value },
                        { nodeId: "126", fieldName: "text", fieldValue: promptText },
                        { nodeId: "88", fieldName: "value", fieldValue: effectSelect.value }
                    ];
                    if (endImageFileEffect) {
                        const endImageUrl = await uploadToCloudinary(endImageFileEffect);
                        nodeInfoList.push(
                            { nodeId: "123", fieldName: "value", fieldValue: "2" },
                            { nodeId: "2", fieldName: "image", fieldValue: endImageUrl }
                        );
                    } else {
                        nodeInfoList.push({ nodeId: "123", fieldName: "value", fieldValue: "1" });
                    }
                } else if (activeVideoMode === 'lip-synch') {
                    if (!uploadedImageFile) throw new Error('Vui lòng tải lên hình ảnh!');
                    if (!uploadedAudioFile) throw new Error('Vui lòng tải lên tệp audio!');
                    setUiLoading(true, 'Đang tải file lên...');
                    
                    const [imageUrl, audioUrl] = await Promise.all([
                        uploadToCloudinary(uploadedImageFile),
                        uploadToCloudinary(uploadedAudioFile)
                    ]);
                    
                    webappId = "1964902712699666433";
                    nodeInfoList = [
                        { nodeId: "15", fieldName: "image", fieldValue: imageUrl },
                        { nodeId: "24", fieldName: "audio", fieldValue: audioUrl },
                        { nodeId: "14", fieldName: "value", fieldValue: durationLipsynch.value },
                        { nodeId: "17", fieldName: "text", fieldValue: promptText }
                    ];
                }
                
                setUiLoading(true, 'Đang khởi tạo tác vụ...');
                const runPayload = { webappId, apiKey: API_KEY, nodeInfoList };
                const runUrl = 'https://www.runninghub.ai/task/openapi/ai-app/run';
                const runResponse = await fetch(runUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(runPayload) });
                if (!runResponse.ok) throw new Error(`Lỗi khi chạy tác vụ: ${runResponse.statusText}`);
                
                const runResult = await runResponse.json();
                if (runResult.code !== 0 || !runResult.data.taskId) {
                     throw new Error(`API không khởi động được tác vụ: ${runResult.msg || 'Không nhận được Task ID'}`);
                }
                currentTaskId = runResult.data.taskId;

                setUiLoading(true, 'Đang xử lý...');
                statusInterval = setInterval(checkTaskStatus, 3000);

            } catch (error) {
                console.error('Lỗi trong quy trình:', error);
                errorMessage.textContent = error.message;
                setUiLoading(false);
            }
        }
        
        async function checkTaskStatus() {
            if (!currentTaskId) { clearInterval(statusInterval); return; }
            try {
                const statusUrl = 'https://www.runninghub.ai/task/openapi/status';
                const payload = { apiKey: API_KEY, taskId: currentTaskId };
                const response = await fetch(statusUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    // Stop polling on network-like errors
                    clearInterval(statusInterval);
                    statusInterval = null;
                    throw new Error(`Lỗi kiểm tra trạng thái: ${response.statusText}`);
                }
                
                const result = await response.json();
                if (result.code !== 0) {
                     clearInterval(statusInterval);
                     statusInterval = null;
                     throw new Error(`Lỗi API trạng thái: ${result.msg}`);
                }

                let status, statusData;
                if (typeof result.data === 'string') {
                    status = result.data;
                    statusData = {}; 
                } else if (typeof result.data === 'object' && result.data !== null) {
                    status = result.data.status;
                    statusData = result.data;
                } else {
                     clearInterval(statusInterval);
                     statusInterval = null;
                     throw new Error('Định dạng phản hồi trạng thái không hợp lệ.');
                }

                switch (status) {
                    case 'SUCCESS':
                        clearInterval(statusInterval); statusInterval = null;
                        fetchTaskOutput();
                        break;
                    case 'RUNNING':
                    case 'PROCESSING':
                        const progress = statusData.progress ? Math.round(statusData.progress * 100) : 0;
                        setUiLoading(true, `Đang xử lý... ${progress > 0 ? progress + '%' : ''}`);
                        break;
                    case 'IN_QUEUE':
                        setUiLoading(true, 'Đang xử lý...');
                        break;
                    case 'FAILED':
                        clearInterval(statusInterval); 
                        statusInterval = null;
                        console.error('Lý do tác vụ thất bại từ server:', statusData.failReason || 'Không có lý do cụ thể.');
                        errorMessage.textContent = 'Không Thành Công';
                        setUiLoading(false);
                        break; 
                    default:
                        setUiLoading(true, `Trạng thái: ${status || 'Không xác định'}`);
                        break;
                }
            } catch (error) {
                console.error('Lỗi khi kiểm tra trạng thái:', error);
                errorMessage.textContent = error.message;
                setUiLoading(false);
                if (statusInterval) clearInterval(statusInterval);
            }
        }

        async function fetchTaskOutput() {
            try {
                setUiLoading(true, 'Đang lấy kết quả...');
                const outputUrl = 'https://www.runninghub.ai/task/openapi/outputs';
                const payload = { apiKey: API_KEY, taskId: currentTaskId };
                const response = await fetch(outputUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Lỗi lấy kết quả: ${response.statusText}`);
                
                const result = await response.json();
                if (result.code !== 0) throw new Error(`API báo lỗi: ${result.msg || 'Lỗi không xác định'}`);
                if (!result.data) throw new Error('API không trả về dữ liệu kết quả.');

                const output = result.data.outputs || result.data;
                if ((typeof output !== 'object' || output === null) && !Array.isArray(output)) {
                    throw new Error('Định dạng dữ liệu kết quả không hợp lệ.');
                }

                let finalVideoUrl = null;
                
                function findVideoUrl(obj) {
                    for (const key in obj) {
                        const value = obj[key];
                        if (typeof value === 'string' && (value.endsWith('.mp4') || value.endsWith('.webm') || value.endsWith('.mov'))) {
                            return value;
                        }
                        if (typeof value === 'object' && value !== null) {
                            const found = findVideoUrl(value);
                            if (found) return found;
                        }
                    }
                    return null;
                }

                finalVideoUrl = findVideoUrl(output);
                
                if (finalVideoUrl) {
                    fallbackImage.style.display = 'none';
                    resultVideo.src = finalVideoUrl;
                    resultVideo.style.display = 'block';
                    resultVideo.play();
                } else {
                     throw new Error('Không tìm thấy video trong kết quả trả về.');
                }
            } catch (error) {
                console.error('Lỗi khi lấy kết quả:', error);
                errorMessage.textContent = error.message;
            } finally {
                setUiLoading(false);
                currentTaskId = null;
            }
        }

        async function cancelTask() {
            if (!currentTaskId) return;
            const taskIdToCancel = currentTaskId;
            resetState(); 
            try {
                const cancelUrl = 'https://www.runninghub.ai/task/openapi/cancel';
                const payload = { apiKey: API_KEY, taskId: taskIdToCancel };
                const response = await fetch(cancelUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await response.json();
                if (result.code !== 0) {
                    console.warn(`API báo lỗi khi hủy tác vụ: ${result.msg}`);
                }
            } catch (error) {
                console.error('Lỗi khi hủy tác vụ:', error);
            }
        }

        // --- INITIAL UI SETUP ---
        switchVideoMode('text-to-video');
    </script>
</body>
</html>

